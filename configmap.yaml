apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-english-config
  namespace: web
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>K8s Live Metrics</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            body { background-color: #f4f7f9; padding-top: 50px; }
            .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
            .metric-value { font-size: 2.5rem; font-weight: bold; color: #0d6efd; }
            .status-ok { color: #22c55e; font-size: 0.9rem; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="text-center mb-5">
                <h1>üöÄ K8s Real-Time Dashboard</h1>
                <p class="text-muted">Fetching live data from Prometheus</p>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-4">
                        <h5>Node IP</h5>
                        <div class="metric-value" style="font-size: 1.5rem;">35.198.73.31</div>
                        <div class="status-ok">‚óè Connected</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-4">
                        <h5>Node CPU Usage</h5>
                        <div id="cpu-usage" class="metric-value">...</div>
                        <div class="text-muted small">Updated every 5s</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-4">
                        <h5>Prometheus API</h5>
                        <div id="prom-status" class="metric-value" style="font-size: 1.5rem;">Checking...</div>
                        <div id="prom-subtext" class="small">Via Ingress Proxy</div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            async function fetchMetrics() {
                const promUrl = '/api/v1/query?query=';
                
                // Query for Node CPU usage (1 minute average)
                const cpuQuery = "100 - (avg by (instance) (irate(node_cpu_seconds_total{mode='idle'}[1m])) * 100)";

                try {
                    const response = await fetch(promUrl + encodeURIComponent(cpuQuery));
                    const data = await response.json();
                    
                    if (data.status === "success" && data.data.result.length > 0) {
                        const val = parseFloat(data.data.result[0].value[1]).toFixed(2);
                        document.getElementById('cpu-usage').innerText = val + "%";
                        document.getElementById('prom-status').innerText = "UP";
                        document.getElementById('prom-status').style.color = "#22c55e";
                    } else {
                        document.getElementById('cpu-usage').innerText = "N/A";
                    }
                } catch (err) {
                    console.error("Prometheus error:", err);
                    document.getElementById('prom-status').innerText = "OFFLINE";
                    document.getElementById('prom-status').style.color = "#dc3545";
                    document.getElementById('cpu-usage').innerText = "ERR";
                    document.getElementById('prom-subtext').innerText = "Check Proxy/Ingress";
                }
            }

            // Initial fetch and set interval
            fetchMetrics();
            setInterval(fetchMetrics, 5000);
        </script>
    </body>
    </html>
