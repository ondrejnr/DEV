---
- name: Deploy and Expose etcd Cluster
  hosts: localhost
  connection: local
  tasks:
    - name: Ensure database namespace exists
      kubernetes.core.k8s:
        name: database
        kind: Namespace
        state: present

    - name: Apply etcd StatefulSet manifest
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: etcd
            namespace: database
          spec:
            serviceName: etcd
            replicas: 1
            selector:
              matchLabels:
                app: etcd
            template:
              metadata:
                labels:
                  app: etcd
              spec:
                initContainers:
                  - name: volume-permissions
                    image: busybox:latest
                    command: ['sh', '-c', 'chown -R 1001:1001 /bitnami/etcd']
                    volumeMounts:
                      - name: data
                        mountPath: /bitnami/etcd
                containers:
                  - name: etcd
                    image: docker.io/bitnami/etcd:3.5.11-debian-11-r0
                    env:
                      - name: ALLOW_NONE_AUTHENTICATION
                        value: "yes"
                      - name: ETCD_DATA_DIR
                        value: "/bitnami/etcd/data"
                    ports:
                      - containerPort: 2379
                        name: client
                      - containerPort: 2380
                        name: peer
                    volumeMounts:
                      - name: data
                        mountPath: /bitnami/etcd
            volumeClaimTemplates:
              - metadata:
                  name: data
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "local-path"
                  resources:
                    requests:
                      storage: 1Gi

    - name: Create etcd Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: etcd
            namespace: database
          spec:
            type: NodePort
            ports:
              - port: 2379
                targetPort: 2379
                nodePort: 30379
            selector:
              app: etcd
